name: Deploy vandan Backend

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      PORT: ${{ secrets.PORT }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      DATAWRAPPER_API_TOKEN: ${{ secrets.DATAWRAPPER_API_TOKEN }}
      DISTRICT_MAP_ID: ${{ secrets.DISTRICT_MAP_ID }}
      VIDHANSABHA_MAP_ID: ${{ secrets.VIDHANSABHA_MAP_ID }}
      LOKSABHA_MAP_ID: ${{ secrets.LOKSABHA_MAP_ID }}
      REDIS_URL: ${{ secrets.REDIS_URL }}
    steps:
      # 1Ô∏è‚É£ Checkout repo in the runner (required to get actions workspace)
      - name: Checkout Source
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Ensure backend folder exists
      - name: Ensure Backend Folder Exists
        run: |
          mkdir -p /home/ubuntu/vandan-backend

      # 3Ô∏è‚É£ Clone repo into a temporary folder
      - name: Clone Repo to Temp Folder
        run: |
          cd /home/ubuntu
          rm -rf vandan-backend-temp
          git clone https://github.com/inspire1201/vandan_yojana_backend vandan-backend-temp

      # 4Ô∏è‚É£ Sync temp folder to persistent backend folder
      - name: Sync Code to Backend Folder
        run: |
          rsync -a --delete /home/ubuntu/vandan-backend-temp/ /home/ubuntu/vandan-backend/

      # 5Ô∏è‚É£ Install Node.js dependencies
      - name: Install Dependencies
        run: |
          cd /home/ubuntu/vandan-backend
          npm install

      # 6Ô∏è‚É£ Prisma generate (if using Prisma)
      - name: Prisma Generate
        run: |
          cd /home/ubuntu/vandan-backend
          npm run generate

      # 7Ô∏è‚É£ Build TypeScript
      - name: Build TypeScript
        run: |
          cd /home/ubuntu/vandan-backend
          npm run build

      # 8Ô∏è‚É£ Stop existing PM2 process (for zero-downtime you can replace with reload)
      - name: Stop and Delete Old PM2 Process
        run: |
          pm2 stop vandan_backend || true
          pm2 delete vandan_backend || true


      # 9Ô∏è‚É£ Start or restart backend with PM2
      - name: Start Backend with PM2
        run: |
          cd /home/ubuntu/vandan-backend
          pm2 start dist/index.js --name vandan_backend --update-env --env production

      # üîü Save PM2 process list to auto-start on reboot
      - name: Save PM2 Process List
        run: pm2 save
